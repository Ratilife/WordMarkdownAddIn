# Техническое задание: Модуль WordMarkdownFormatter

## 1. Общее описание

### 1.1. Назначение модуля
Модуль `WordMarkdownFormatter` предназначен для автоматического форматирования текста в документе Microsoft Word, который содержит синтаксис Markdown. При активации модуль находит все элементы синтаксиса Markdown в документе, применяет соответствующие стили форматирования Word и удаляет синтаксические маркеры Markdown.

### 1.2. Основная функциональность
- Поиск и распознавание синтаксиса Markdown в тексте документа Word
- Применение форматирования Word к найденным элементам
- Удаление синтаксических маркеров Markdown после применения форматирования
- Обработка как выделенного текста, так и всего документа
- Поддержка основных элементов Markdown: заголовки, жирный текст, курсив, списки, таблицы, ссылки, код и др.

### 1.3. Триггер активации
Модуль активируется при нажатии пользователем на кнопку в ленте Word (Ribbon). Кнопка должна быть размещена в группе "Форматирование" или аналогичной группе интерфейса.

---

## 2. Архитектура модуля

### 2.1. Структура классов

#### 2.1.1. Класс `WordMarkdownFormatter`
**Назначение:** Основной класс модуля, координирующий процесс форматирования Markdown в документе Word.

**Расположение:** `Services/WordMarkdownFormatter.cs`

**Ответственность:**
- Инициализация работы с активным документом Word
- Координация процесса поиска и форматирования
- Управление порядком обработки различных типов элементов Markdown
- Обработка ошибок и логирование

---

#### 2.1.2. Класс `MarkdownPatternMatcher`
**Назначение:** Класс для поиска и распознавания синтаксиса Markdown в тексте документа.

**Расположение:** `Services/WordMarkdownFormatter.cs` (вложенный класс или отдельный файл)

**Ответственность:**
- Определение паттернов синтаксиса Markdown через регулярные выражения
- Поиск всех вхождений Markdown-синтаксиса в указанном диапазоне текста
- Извлечение содержимого и метаданных из найденных паттернов
- Определение типа элемента Markdown (заголовок, жирный, курсив и т.д.)

---

#### 2.1.3. Класс `MarkdownElementFormatter`
**Назначение:** Класс для применения форматирования Word к найденным элементам Markdown.

**Расположение:** `Services/WordMarkdownFormatter.cs` (вложенный класс или отдельный файл)

**Ответственность:**
- Применение стилей Word к различным типам элементов Markdown
- Удаление синтаксических маркеров после применения форматирования
- Сохранение позиций и диапазонов для корректной замены текста
- Обработка вложенных элементов форматирования

---

#### 2.1.4. Класс `FormattingContext`
**Назначение:** Вспомогательный класс для хранения контекста форматирования во время обработки.

**Расположение:** `Services/WordMarkdownFormatter.cs` (вложенный класс)

**Ответственность:**
- Хранение информации о текущем диапазоне обработки
- Отслеживание позиций в документе
- Сохранение состояния форматирования для отката при ошибках
- Кэширование результатов поиска

---

### 2.2. Переменные класса `WordMarkdownFormatter`

#### 2.2.1. Приватные поля

**`_wordApp` (тип: `Microsoft.Office.Interop.Word.Application`)**
- **Назначение:** Ссылка на объект приложения Microsoft Word
- **Инициализация:** Получается через `Globals.ThisAddIn.Application` в конструкторе
- **Использование:** Доступ к активному документу и его элементам

**`_activeDoc` (тип: `Microsoft.Office.Interop.Word.Document`)**
- **Назначение:** Ссылка на активный документ Word
- **Инициализация:** Получается из `_wordApp.ActiveDocument` в конструкторе
- **Использование:** Работа с содержимым документа, параграфами, диапазонами

**`_patternMatcher` (тип: `MarkdownPatternMatcher`)**
- **Назначение:** Экземпляр класса для поиска Markdown-паттернов
- **Инициализация:** Создается в конструкторе
- **Использование:** Поиск и распознавание синтаксиса Markdown

**`_elementFormatter` (тип: `MarkdownElementFormatter`)**
- **Назначение:** Экземпляр класса для применения форматирования
- **Инициализация:** Создается в конструкторе
- **Использование:** Применение стилей Word и удаление синтаксиса

**`_processingOrder` (тип: `List<MarkdownElementType>`)**
- **Назначение:** Порядок обработки различных типов элементов Markdown
- **Инициализация:** Инициализируется в конструкторе списком приоритетов
- **Использование:** Определяет последовательность обработки (например, сначала заголовки, потом форматирование текста)

**`_isProcessing` (тип: `bool`)**
- **Назначение:** Флаг, указывающий на активный процесс форматирования
- **Инициализация:** `false` по умолчанию
- **Использование:** Предотвращение повторного запуска во время обработки

---

#### 2.2.2. Константы

**`MaxDocumentSize` (тип: `int`, значение: `10000000`)**
- **Назначение:** Максимальный размер документа в символах для обработки
- **Использование:** Проверка перед началом форматирования для предотвращения зависаний

**`MaxPatternMatches` (тип: `int`, значение: `10000`)**
- **Назначение:** Максимальное количество найденных паттернов для обработки за один раз
- **Использование:** Защита от переполнения памяти при обработке больших документов

---

### 2.3. Методы класса `WordMarkdownFormatter`

#### 2.3.1. Публичные методы

**`FormatMarkdownInWord(Range targetRange = null)`**
- **Назначение:** Главный метод модуля, запускающий процесс форматирования
- **Параметры:**
  - `targetRange` (тип: `Microsoft.Office.Interop.Word.Range`, опциональный): Диапазон текста для обработки. Если `null`, обрабатывается весь документ
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Проверка доступности документа и валидация входных данных
  2. Определение диапазона обработки (выделенный текст или весь документ)
  3. Проверка размера документа на соответствие ограничениям
  4. Установка флага `_isProcessing = true`
  5. Вызов метода поиска всех Markdown-элементов
  6. Сортировка найденных элементов по приоритету обработки
  7. Последовательное применение форматирования к каждому элементу
  8. Очистка и сброс флага `_isProcessing = false`
  9. Обработка исключений и логирование ошибок

**`FormatSelectedText()`**
- **Назначение:** Удобный метод для форматирования только выделенного пользователем текста
- **Параметры:** Отсутствуют
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение выделенного диапазона через `_wordApp.Selection.Range`
  2. Проверка наличия выделенного текста
  3. Вызов `FormatMarkdownInWord()` с выделенным диапазоном

**`FormatEntireDocument()`**
- **Назначение:** Удобный метод для форматирования всего документа
- **Параметры:** Отсутствуют
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение всего содержимого документа через `_activeDoc.Content`
  2. Вызов `FormatMarkdownInWord()` с диапазоном всего документа

**`CanFormat()` (тип возврата: `bool`)**
- **Назначение:** Проверка возможности выполнения форматирования
- **Параметры:** Отсутствуют
- **Возвращаемое значение:** `true` если форматирование возможно, `false` в противном случае
- **Функционал:**
  1. Проверка наличия активного документа
  2. Проверка, что документ не защищен от изменений
  3. Проверка, что процесс форматирования не запущен (`_isProcessing == false`)
  4. Проверка размера документа

---

#### 2.3.2. Приватные методы

**`FindAllMarkdownElements(Range range)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск всех элементов Markdown в указанном диапазоне
- **Параметры:**
  - `range` (тип: `Microsoft.Office.Interop.Word.Range`): Диапазон для поиска
- **Возвращаемое значение:** Список найденных элементов с их позициями и типами
- **Функционал:**
  1. Извлечение текста из диапазона
  2. Вызов методов `_patternMatcher` для поиска различных типов элементов
  3. Объединение результатов поиска
  4. Сортировка по позиции в документе (от начала к концу)
  5. Фильтрация перекрывающихся элементов (приоритет более длинным или более специфичным)

**`ApplyFormattingToElement(MarkdownElementMatch element)`**
- **Назначение:** Применение форматирования к одному найденному элементу
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный элемент Markdown
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Определение типа элемента
  2. Вызов соответствующего метода `_elementFormatter` для данного типа
  3. Обработка ошибок при применении форматирования

**`ValidateDocument()` (тип возврата: `bool`)**
- **Назначение:** Валидация состояния документа перед форматированием
- **Параметры:** Отсутствуют
- **Возвращаемое значение:** `true` если документ валиден, `false` в противном случае
- **Функционал:**
  1. Проверка наличия `_activeDoc`
  2. Проверка, что документ не только для чтения
  3. Проверка размера документа
  4. Проверка доступности COM-объектов

**`LogError(string message, Exception exception = null)`**
- **Назначение:** Логирование ошибок в процессе форматирования
- **Параметры:**
  - `message` (тип: `string`): Сообщение об ошибке
  - `exception` (тип: `Exception`, опциональный): Исключение, если есть
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Запись в `System.Diagnostics.Debug`
  2. Возможно, запись в файл лога (если требуется)

**`ResetProcessingState()`**
- **Назначение:** Сброс состояния обработки после завершения или ошибки
- **Параметры:** Отсутствуют
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Установка `_isProcessing = false`
  2. Очистка временных данных
  3. Освобождение ресурсов

---

### 2.4. Переменные класса `MarkdownPatternMatcher`

#### 2.4.1. Приватные поля

**`_headingPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска заголовков Markdown (`# Заголовок`, `## Заголовок` и т.д.)
- **Паттерн:** `^#{1,6}\s+(.+)$` (с учетом многострочного режима)
- **Использование:** Поиск заголовков уровней 1-6

**`_boldPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска жирного текста (`**текст**`)
- **Паттерн:** `\*\*(.+?)\*\*`
- **Использование:** Поиск текста, заключенного в двойные звездочки

**`_italicPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска курсива (`*текст*`)
- **Паттерн:** `(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)`
- **Использование:** Поиск текста, заключенного в одинарные звездочки (не двойные)

**`_strikethroughPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска зачеркнутого текста (`~~текст~~`)
- **Паттерн:** `~~(.+?)~~`
- **Использование:** Поиск текста, заключенного в двойные тильды

**`_inlineCodePattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска инлайн-кода (`` `код` ``)
- **Паттерн:** `` `([^`]+)` ``
- **Использование:** Поиск кода, заключенного в обратные кавычки

**`_linkPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска ссылок (`[текст](url)`)
- **Паттерн:** `\[([^\]]+)\]\(([^\)]+)\)`
- **Использование:** Поиск ссылок с извлечением текста и URL

**`_listItemPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска элементов списка (`- элемент`, `* элемент`, `1. элемент`)
- **Паттерн:** `^[\-\*\+]\s+(.+)$` или `^\d+\.\s+(.+)$`
- **Использование:** Поиск маркированных и нумерованных списков

**`_codeBlockPattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска блоков кода (```код```)
- **Паттерн:** `` ```[\s\S]*?``` ``
- **Использование:** Поиск многострочных блоков кода

**`_tablePattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска таблиц Markdown
- **Паттерн:** Сложный паттерн для таблиц с разделителями `|`
- **Использование:** Поиск таблиц в формате Markdown

**`_quotePattern` (тип: `Regex`)**
- **Назначение:** Регулярное выражение для поиска цитат (`> цитата`)
- **Паттерн:** `^>\s+(.+)$`
- **Использование:** Поиск блоков цитат

---

#### 2.4.2. Методы класса `MarkdownPatternMatcher`

**`FindHeadings(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск всех заголовков в тексте
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных заголовков с их уровнями и позициями
- **Функционал:**
  1. Применение `_headingPattern` к тексту
  2. Извлечение уровня заголовка (количество `#`)
  3. Извлечение текста заголовка
  4. Сохранение позиции начала и конца в исходном тексте
  5. Возврат списка совпадений

**`FindBoldText(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск жирного текста
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных вхождений жирного текста
- **Функционал:** Аналогично `FindHeadings`, но для жирного текста

**`FindItalicText(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск курсива
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных вхождений курсива
- **Функционал:** Аналогично предыдущим методам

**`FindStrikethroughText(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск зачеркнутого текста
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных вхождений зачеркнутого текста
- **Функционал:** Аналогично предыдущим методам

**`FindInlineCode(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск инлайн-кода
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных вхождений инлайн-кода
- **Функционал:** Аналогично предыдущим методам

**`FindLinks(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск ссылок
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных ссылок с текстом и URL
- **Функционал:** Аналогично предыдущим методам, но с извлечением URL

**`FindListItems(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск элементов списков
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных элементов списков
- **Функционал:** Аналогично предыдущим методам, с определением типа списка (маркированный/нумерованный)

**`FindCodeBlocks(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск блоков кода
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных блоков кода
- **Функционал:** Аналогично предыдущим методам, с извлечением языка программирования (если указан)

**`FindTables(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск таблиц
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных таблиц
- **Функционал:** Сложная логика парсинга таблиц с извлечением строк и столбцов

**`FindQuotes(string text)` (тип возврата: `List<MarkdownElementMatch>`)**
- **Назначение:** Поиск цитат
- **Параметры:**
  - `text` (тип: `string`): Текст для поиска
- **Возвращаемое значение:** Список найденных цитат
- **Функционал:** Аналогично предыдущим методам

---

### 2.5. Переменные класса `MarkdownElementFormatter`

#### 2.5.1. Приватные поля

**`_activeDoc` (тип: `Microsoft.Office.Interop.Word.Document`)**
- **Назначение:** Ссылка на активный документ для применения форматирования
- **Инициализация:** Передается через конструктор
- **Использование:** Доступ к стилям и форматированию документа

**`_wordApp` (тип: `Microsoft.Office.Interop.Word.Application`)**
- **Назначение:** Ссылка на приложение Word
- **Инициализация:** Передается через конструктор
- **Использование:** Доступ к глобальным настройкам Word

---

#### 2.5.2. Методы класса `MarkdownElementFormatter`

**`FormatHeading(MarkdownElementMatch element)`**
- **Назначение:** Применение стиля заголовка к найденному элементу
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный заголовок с уровнем
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Определение уровня заголовка из элемента
  2. Выбор соответствующего стиля Word (`Heading 1`, `Heading 2` и т.д.)
  3. Получение диапазона текста заголовка в документе
  4. Применение стиля к диапазону
  5. Удаление символов `#` и пробелов из начала строки
  6. Обновление текста в документе

**`FormatBoldText(MarkdownElementMatch element)`**
- **Назначение:** Применение жирного форматирования
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный жирный текст
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение диапазона текста в документе
  2. Установка `Font.Bold = true` для диапазона
  3. Удаление символов `**` до и после текста
  4. Обновление текста в документе

**`FormatItalicText(MarkdownElementMatch element)`**
- **Назначение:** Применение курсива
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный курсивный текст
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение диапазона текста в документе
  2. Установка `Font.Italic = true` для диапазона
  3. Удаление символов `*` до и после текста
  4. Обновление текста в документе

**`FormatStrikethroughText(MarkdownElementMatch element)`**
- **Назначение:** Применение зачеркивания
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный зачеркнутый текст
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение диапазона текста в документе
  2. Установка `Font.StrikeThrough = true` для диапазона
  3. Удаление символов `~~` до и после текста
  4. Обновление текста в документе

**`FormatInlineCode(MarkdownElementMatch element)`**
- **Назначение:** Применение форматирования для инлайн-кода
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный инлайн-код
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение диапазона текста в документе
  2. Установка моноширинного шрифта (например, `Font.Name = "Courier New"`)
  3. Возможно, установка фонового цвета для выделения кода
  4. Удаление символов обратных кавычек `` ` ``
  5. Обновление текста в документе

**`FormatLink(MarkdownElementMatch element)`**
- **Назначение:** Создание гиперссылки из Markdown-ссылки
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденная ссылка с текстом и URL
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Извлечение текста ссылки и URL из элемента
  2. Получение диапазона текста ссылки в документе
  3. Замена текста `[текст](url)` на `текст`
  4. Создание гиперссылки через `Hyperlinks.Add()` с указанным URL
  5. Применение подчеркивания к гиперссылке

**`FormatListItem(MarkdownElementMatch element)`**
- **Назначение:** Применение форматирования списка
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный элемент списка
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Определение типа списка (маркированный или нумерованный)
  2. Получение диапазона параграфа, содержащего элемент списка
  3. Применение `ListFormat` к параграфу
  4. Удаление маркера списка (`-`, `*`, `+` или `1.`, `2.` и т.д.)
  5. Обновление текста в документе

**`FormatCodeBlock(MarkdownElementMatch element)`**
- **Назначение:** Применение форматирования для блока кода
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденный блок кода
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Извлечение текста кода и языка программирования (если указан)
  2. Получение диапазона блока кода в документе
  3. Применение моноширинного шрифта ко всему блоку
  4. Возможно, применение специального стиля параграфа для кода
  5. Удаление символов ``` из начала и конца блока
  6. Обновление текста в документе

**`FormatTable(MarkdownElementMatch element)`**
- **Назначение:** Создание таблицы Word из Markdown-таблицы
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденная таблица
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Парсинг структуры таблицы (строки, столбцы, ячейки)
  2. Получение диапазона таблицы в документе
  3. Удаление текста таблицы в формате Markdown
  4. Создание таблицы Word через `Tables.Add()`
  5. Заполнение ячеек таблицы данными
  6. Применение форматирования к таблице (границы, стили)

**`FormatQuote(MarkdownElementMatch element)`**
- **Назначение:** Применение стиля цитаты
- **Параметры:**
  - `element` (тип: `MarkdownElementMatch`): Найденная цитата
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Получение диапазона цитаты в документе
  2. Применение стиля `Quote` к параграфу
  3. Удаление символов `>` из начала строк
  4. Обновление текста в документе

**`RemoveMarkdownSyntax(Range range, string syntaxToRemove)`**
- **Назначение:** Удаление синтаксических маркеров из текста
- **Параметры:**
  - `range` (тип: `Microsoft.Office.Interop.Word.Range`): Диапазон текста
  - `syntaxToRemove` (тип: `string`): Строка синтаксиса для удаления
- **Возвращаемое значение:** `void`
- **Функционал:**
  1. Поиск подстроки `syntaxToRemove` в диапазоне
  2. Удаление найденной подстроки
  3. Обновление диапазона

---

### 2.6. Вспомогательные структуры и классы

#### 2.6.1. Класс `MarkdownElementMatch`
**Назначение:** Структура данных для хранения информации о найденном элементе Markdown

**Поля:**
- `ElementType` (тип: `MarkdownElementType`): Тип элемента (Heading, Bold, Italic и т.д.)
- `StartPosition` (тип: `int`): Позиция начала элемента в документе
- `EndPosition` (тип: `int`): Позиция конца элемента в документе
- `Content` (тип: `string`): Извлеченное содержимое элемента (без синтаксиса)
- `FullMatch` (тип: `string`): Полное совпадение с синтаксисом Markdown
- `Metadata` (тип: `Dictionary<string, object>`): Дополнительные метаданные (уровень заголовка, URL ссылки и т.д.)

---

#### 2.6.2. Перечисление `MarkdownElementType`
**Назначение:** Определение типов элементов Markdown

**Значения:**
- `Heading` - Заголовок
- `Bold` - Жирный текст
- `Italic` - Курсив
- `Strikethrough` - Зачеркнутый текст
- `InlineCode` - Инлайн-код
- `CodeBlock` - Блок кода
- `Link` - Ссылка
- `ListItem` - Элемент списка
- `Table` - Таблица
- `Quote` - Цитата
- `HorizontalRule` - Горизонтальная линия

---

## 3. Последовательность работы модуля

### 3.1. Инициализация
1. Пользователь нажимает кнопку в ленте Word
2. Создается экземпляр класса `WordMarkdownFormatter`
3. Проверяется доступность активного документа
4. Инициализируются `MarkdownPatternMatcher` и `MarkdownElementFormatter`

### 3.2. Определение области обработки
1. Проверяется, есть ли выделенный текст
2. Если выделения нет, определяется диапазон всего документа
3. Выполняется валидация размера и доступности диапазона

### 3.3. Поиск элементов Markdown
1. Извлекается текст из диапазона
2. Последовательно вызываются методы поиска для каждого типа элемента
3. Результаты объединяются в общий список
4. Выполняется сортировка по позиции в документе
5. Устраняются перекрывающиеся элементы

### 3.4. Применение форматирования
1. Элементы обрабатываются в порядке приоритета (заголовки → блоки → форматирование текста)
2. Для каждого элемента вызывается соответствующий метод форматирования
3. Применяются стили Word
4. Удаляются синтаксические маркеры Markdown
5. Обновляется текст в документе

### 3.5. Завершение
1. Сбрасывается флаг обработки
2. Очищаются временные данные
3. Выводится сообщение об успешном завершении (опционально)
4. Логируются результаты обработки

---

## 4. Обработка ошибок

### 4.1. Типы ошибок
- Отсутствие активного документа
- Документ защищен от изменений
- Превышение размера документа
- Ошибки COM-взаимодействия с Word
- Некорректный синтаксис Markdown
- Ошибки при применении форматирования

### 4.2. Стратегия обработки
- Все ошибки логируются через `LogError()`
- Критические ошибки прерывают процесс форматирования
- Некритические ошибки пропускаются с продолжением обработки остальных элементов
- Пользователю выводится понятное сообщение об ошибке

---

## 5. Интеграция с существующей системой

### 5.1. Связь с другими модулями
- Модуль использует существующие классы `IWordElement` для работы с элементами Word
- Может использовать `MarkdownToWordFormatter` для сложных преобразований (опционально)
- Интегрируется с системой логирования проекта

### 5.2. Добавление кнопки в Ribbon
- Кнопка добавляется в файл `MarkdownRibbon.Designer.cs`
- Обработчик события создается в `MarkdownRibbon.cs`
- Обработчик вызывает метод `FormatMarkdownInWord()` или `FormatSelectedText()`

---

## 6. Ограничения и требования

### 6.1. Ограничения
- Максимальный размер обрабатываемого документа: 10,000,000 символов
- Максимальное количество найденных элементов: 10,000
- Обработка выполняется синхронно (может блокировать UI для больших документов)

### 6.2. Требования
- Microsoft Word 2013 или выше
- .NET Framework 4.7.2 или выше
- Библиотека Markdig (уже используется в проекте)
- Доступ к COM-интерфейсам Word

---

## 7. Будущие улучшения

### 7.1. Возможные расширения
- Асинхронная обработка для больших документов
- Поддержка дополнительных элементов Markdown (таблицы, математические формулы)
- Настройки пользователя для выбора стилей форматирования
- Предварительный просмотр изменений перед применением
- Откат изменений (Undo)
- Пакетная обработка нескольких документов

---

## 8. Тестирование

### 8.1. Сценарии тестирования
- Форматирование выделенного текста
- Форматирование всего документа
- Обработка различных типов элементов Markdown
- Обработка вложенных элементов (жирный текст внутри заголовка)
- Обработка больших документов
- Обработка документов с ошибками
- Обработка защищенных документов

### 8.2. Критерии приемки
- Все элементы Markdown корректно распознаются
- Форматирование применяется правильно
- Синтаксис Markdown полностью удаляется
- Документ остается валидным после обработки
- Производительность приемлема для документов до 100,000 символов


