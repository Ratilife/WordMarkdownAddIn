# Схема потока данных и взаимодействия компонентов

## Общая архитектура

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           WORD ADD-IN APPLICATION                        │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  C# Layer (TaskPaneControl.cs)                                   │   │
│  │  ┌────────────────────────────────────────────────────────────┐ │   │
│  │  │  UserControl (Windows Forms)                                │ │   │
│  │  │  ┌──────────────────────────────────────────────────────┐  │ │   │
│  │  │  │  WebView2 Component                                   │  │ │   │
│  │  │  │  ┌────────────────────────────────────────────────┐  │  │ │   │
│  │  │  │  │  HTML Document (BuildHtmlShell)                │  │  │ │   │
│  │  │  │  │  ┌──────────────────────────────────────────┐  │  │ │   │
│  │  │  │  │  │  JavaScript Runtime                       │  │  │ │   │
│  │  │  │  │  │  • Editor Logic                           │  │  │ │   │
│  │  │  │  │  │  • Event Handlers                         │  │  │ │   │
│  │  │  │  │  │  • API Functions                          │  │  │ │   │
│  │  │  │  │  └──────────────────────────────────────────┘  │  │ │   │
│  │  │  │  └────────────────────────────────────────────────┘  │  │ │   │
│  │  │  └──────────────────────────────────────────────────────┘  │ │   │
│  │  └────────────────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────┐ │   │
│  │  │  MarkdownRenderService                                     │ │   │
│  │  │  • Markdig Pipeline                                        │ │   │
│  │  │  • Markdown → HTML                                         │ │   │
│  │  └────────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## Детальная схема взаимодействия C# ↔ JavaScript

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    НАПРАВЛЕНИЕ: C# → JavaScript                          │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐
│  C# Method   │  InsertHeading(2), SetMarkdown(), etc.
└──────┬───────┘
       │
       │ 1. Подготовка данных
       ▼
┌─────────────────────────────┐
│ Convert.ToBase64String(     │
│   Encoding.UTF8.GetBytes()  │
│ )                           │
└──────┬──────────────────────┘
       │
       │ 2. Формирование JS кода
       ▼
┌─────────────────────────────┐
│ ExecuteScriptAsync(          │
│   $"window.function(         │
│      atob('{base64}')       │
│   )"                        │
│ )                           │
└──────┬──────────────────────┘
       │
       │ 3. WebView2 выполняет JS
       ▼
┌─────────────────────────────┐
│  JavaScript Function        │
│  window.function(text) {    │
│    // text уже декодирован  │
│    // atob() выполнен       │
│  }                          │
└─────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                    НАПРАВЛЕНИЕ: JavaScript → C#                          │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐
│ JavaScript   │  notifyChange(), postToHost()
│ Event        │
└──────┬───────┘
       │
       │ 1. Подготовка данных
       ▼
┌─────────────────────────────┐
│ btoa(encodeURIComponent(    │
│   text                      │
│ ))                          │
└──────┬──────────────────────┘
       │
       │ 2. Отправка сообщения
       ▼
┌─────────────────────────────┐
│ window.chrome.webview       │
│   .postMessage(             │
│     "type|base64Data"       │
│   )                         │
└──────┬──────────────────────┘
       │
       │ 3. WebView2 передает событие
       ▼
┌─────────────────────────────┐
│ WebMessageReceived Event    │
│ (C# Event Handler)         │
└──────┬──────────────────────┘
       │
       │ 4. Обработка в C#
       ▼
┌─────────────────────────────┐
│ CoreWebView2_WebMessage      │
│ Received()                  │
│ • Split by '|'              │
│ • Decode Base64             │
│ • Process by type           │
└─────────────────────────────┘
```

## Полный цикл обработки изменения текста

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ЦИКЛ: Редактирование Markdown                         │
└─────────────────────────────────────────────────────────────────────────┘

    [Пользователь]
         │
         │ Вводит: "Hello **World**"
         ▼
┌────────────────────┐
│  <textarea>        │  JavaScript DOM
│  #editor           │
└───────┬────────────┘
        │
        │ Событие: 'input'
        ▼
┌────────────────────┐
│  debounce()        │  Задержка 120ms
│  (защита от спама) │
└───────┬────────────┘
        │
        │ notifyChange()
        ▼
┌────────────────────────────────────┐
│  postToHost('mdChanged', text)     │
│  • btoa(encodeURIComponent(...))   │
│  • postMessage('mdChanged|...')    │
└───────┬────────────────────────────┘
        │
        │ WebView2 Bridge
        ▼
┌────────────────────────────────────┐
│  C#: WebMessageReceived            │
│  • Получено: "mdChanged|SGVsbG8..."│
│  • Split: ["mdChanged", "SGVsbG8"] │
│  • Decode: "Hello **World**"       │
└───────┬────────────────────────────┘
        │
        │ Сохранение в кэш
        ▼
┌────────────────────────────────────┐
│  _latestMarkdown = "Hello **World**"│
└───────┬────────────────────────────┘
        │
        │ Рендеринг
        ▼
┌────────────────────────────────────┐
│  MarkdownRenderService             │
│  RenderoHtml("Hello **World**")   │
│  → "<p>Hello <strong>World</strong></p>"│
└───────┬────────────────────────────┘
        │
        │ PostRenderHtml()
        ▼
┌────────────────────────────────────┐
│  Convert.ToBase64String(html)      │
│  ExecuteScriptAsync(               │
│    "window.renderHtml(atob('...'))"│
│  )                                 │
└───────┬────────────────────────────┘
        │
        │ WebView2 Bridge
        ▼
┌────────────────────────────────────┐
│  JavaScript: window.renderHtml()   │
│  • atob('...') → HTML              │
│  • DOMPurify.sanitize()            │
│  • preview.innerHTML = clean      │
│  • Prism.highlightAllUnder()       │
│  • mermaid.init()                  │
│  • MathJax.typesetPromise()        │
└───────┬────────────────────────────┘
        │
        │ Отображение
        ▼
┌────────────────────┐
│  <div>#preview     │  HTML Preview
│  Hello World       │  (жирный текст)
└────────────────────┘
        │
        ▼
    [Пользователь видит результат]
```

## Схема вызова метода из Ribbon

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ВЫЗОВ: Вставка заголовка из Ribbon                    │
└─────────────────────────────────────────────────────────────────────────┘

    [Пользователь нажимает кнопку "H2"]
         │
         ▼
┌────────────────────┐
│  MarkdownRibbon    │  C# Ribbon
│  bHeading2_Click() │
└───────┬────────────┘
        │
        │ Вызов метода
        ▼
┌────────────────────┐
│  TaskPaneControl   │
│  .InsertHeading(2) │
└───────┬────────────┘
        │
        │ Валидация и генерация
        ▼
┌────────────────────┐
│  new string('#', 2)│
│  → "## "           │
└───────┬────────────┘
        │
        │ InsertSnippet("\n## ")
        ▼
┌────────────────────────────────────┐
│  Convert.ToBase64String(           │
│    Encoding.UTF8.GetBytes("\n## ") │
│  )                                 │
│  → "CgojIyA="                      │
└───────┬────────────────────────────┘
        │
        │ ExecuteScriptAsync()
        ▼
┌────────────────────────────────────┐
│  window.insertSnippet(             │
│    atob('CgojIyA=')                │
│  )                                 │
└───────┬────────────────────────────┘
        │
        │ JavaScript выполнение
        ▼
┌────────────────────────────────────┐
│  window.insertSnippet() {          │
│    const pos = editor.selectionStart│
│    editor.value =                  │
│      val.substring(0, pos) +       │
│      "\n## " +                     │
│      val.substring(pos)            │
│    editor.setSelectionRange(...)   │
│    editor.focus()                  │
│    notifyChange() ←───────────────┐│
│  }                                 ││
└────────────────────────────────────┘│
        │                              │
        │ Текст вставлен               │
        ▼                              │
┌────────────────────┐                │
│  <textarea>         │                │
│  ...\n## |         │                │
│  (курсор здесь)     │                │
└────────────────────┘                │
                                      │
        ┌─────────────────────────────┘
        │ Запускается цикл обработки
        ▼
    [См. "Полный цикл обработки" выше]
```

## Схема инициализации

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ПОСЛЕДОВАТЕЛЬНОСТЬ ИНИЦИАЛИЗАЦИИ                      │
└─────────────────────────────────────────────────────────────────────────┘

┌────────────────────┐
│  ThisAddIn         │
│  .Startup()        │
└───────┬────────────┘
        │
        │ Создание контрола
        ▼
┌────────────────────┐
│  new TaskPane      │
│  Control()         │
│  ┌───────────────┐ │
│  │ • _renderer   │ │
│  │ • _webView    │ │
│  │ • Load +=     │ │
│  │   OnLoadAsync │ │
│  └───────────────┘ │
└───────┬────────────┘
        │
        │ Событие Load
        ▼
┌────────────────────┐
│  OnLoadAsync()     │
│  ┌───────────────┐ │
│  │ 1. await      │ │
│  │    EnsureCore │ │
│  │    WebView2   │ │
│  │    Async()    │ │
│  │               │ │
│  │ 2. _coreReady │ │
│  │    = true     │ │
│  │               │ │
│  │ 3. Subscribe │ │
│  │    WebMessage │ │
│  │    Received   │ │
│  │               │ │
│  │ 4. Settings   │ │
│  │               │ │
│  │ 5. Navigate   │ │
│  │    ToString(  │ │
│  │    BuildHtml  │ │
│  │    Shell())   │ │
│  └───────────────┘ │
└───────┬────────────┘
        │
        │ Загрузка HTML
        ▼
┌────────────────────┐
│  BuildHtmlShell()  │
│  ┌───────────────┐ │
│  │ • HTML        │ │
│  │ • CSS         │ │
│  │ • <script>    │ │
│  │   блоки       │ │
│  └───────────────┘ │
└───────┬────────────┘
        │
        │ HTML загружен в WebView2
        ▼
┌────────────────────┐
│  JavaScript        │
│  Инициализация     │
│  ┌───────────────┐ │
│  │ • Загрузка    │ │
│  │   библиотек   │ │
│  │ • Переменные  │ │
│  │ • Обработчики │ │
│  │ • window.*    │ │
│  │   функции     │ │
│  │ • setTimeout  │ │
│  │   (init)      │ │
│  └───────────────┘ │
└───────┬────────────┘
        │
        │ Готово к работе
        ▼
┌────────────────────┐
│  Редактор готов    │
│  • Можно вводить   │
│  • Можно вызывать │
│    методы из C#    │
└────────────────────┘
```

## Ключевые точки взаимодействия

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ТОЧКИ ВЗАИМОДЕЙСТВИЯ                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  ТОЧКА 1: C# → JavaScript (Вызов функций)                          │
├─────────────────────────────────────────────────────────────────────┤
│  Метод: ExecuteScriptAsync()                                        │
│  Формат: "window.functionName(atob('base64Data'))"                  │
│  Примеры:                                                           │
│    • window.editorSetValue(atob('SGVsbG8='))                       │
│    • window.insertSnippet(atob('IyA='))                            │
│    • window.renderHtml(atob('PHA+SGVsbG88L3A+'))                    │
│    • window.setViewMode('split')                                    │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  ТОЧКА 2: JavaScript → C# (Отправка сообщений)                      │
├─────────────────────────────────────────────────────────────────────┤
│  Метод: window.chrome.webview.postMessage()                         │
│  Формат: "type|base64Data"                                          │
│  Примеры:                                                           │
│    • "mdChanged|SGVsbG8gV29ybGQ="                                   │
│    • "viewModeChanged|c3BsaXQ="                                     │
│  Обработчик: CoreWebView2_WebMessageReceived()                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  ТОЧКА 3: Кэширование данных                                        │
├─────────────────────────────────────────────────────────────────────┤
│  Переменная: _latestMarkdown                                        │
│  Обновляется: При получении "mdChanged"                             │
│  Используется: GetCachedMarkdown(), GetMarkdownAsync()              │
│  Цель: Быстрый доступ без запроса к JavaScript                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  ТОЧКА 4: Рендеринг Markdown                                        │
├─────────────────────────────────────────────────────────────────────┤
│  Сервис: MarkdownRenderService                                      │
│  Метод: RenderoHtml(markdown)                                       │
│  Вход: Markdown текст                                               │
│  Выход: HTML строка                                                 │
│  Использует: Markdig pipeline                                       │
└─────────────────────────────────────────────────────────────────────┘
```

## Формат передачи данных

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ФОРМАТ СООБЩЕНИЙ                                     │
└─────────────────────────────────────────────────────────────────────────┘

JavaScript → C#:
┌──────────┬────────────────────────────────────────┐
│   Тип    │            Данные (Base64)             │
│          │                                        │
│ mdChanged│ SGVsbG8gV29ybGQ=                       │
│          │ (Hello World)                          │
└──────────┴────────────────────────────────────────┘
     │                    │
     └────────┬───────────┘
              │
         Разделитель: '|'
         Формат: "type|base64Data"

Примеры:
  "mdChanged|SGVsbG8gV29ybGQ="
  "viewModeChanged|c3BsaXQ="  (split)
  "viewModeChanged|bWFya2Rvd24="  (markdown)
```

## Визуализация компонентов в памяти

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    СТРУКТУРА В ПАМЯТИ                                     │
└─────────────────────────────────────────────────────────────────────────┘

TaskPaneControl (C# объект)
├── _webView (WebView2)
│   └── CoreWebView2
│       ├── Settings
│       ├── NavigateToString()
│       ├── ExecuteScriptAsync()
│       └── WebMessageReceived (event)
│
├── _renderer (MarkdownRenderService)
│   └── _pipeline (MarkdownPipeline)
│
├── _latestMarkdown (string)
│   └── Кэш текущего Markdown текста
│
└── _coreReady (bool)
    └── Флаг готовности WebView2

WebView2 (внутренний процесс)
└── HTML Document
    ├── <head>
    │   ├── <style> (CSS)
    │   └── <script> (внешние библиотеки)
    │
    └── <body>
        ├── <div class="view-controls">
        ├── <div class="container">
        │   ├── <textarea id="editor">
        │   └── <div id="preview">
        │
        └── <script>
            ├── const editor = ...
            ├── const preview = ...
            ├── function postToHost() { ... }
            ├── function notifyChange() { ... }
            ├── window.editorSetValue = ...
            ├── window.editorGetValue = ...
            ├── window.insertAroundSelection = ...
            ├── window.insertSnippet = ...
            ├── window.renderHtml = ...
            ├── window.setViewMode = ...
            └── window.getViewMode = ...
```



















