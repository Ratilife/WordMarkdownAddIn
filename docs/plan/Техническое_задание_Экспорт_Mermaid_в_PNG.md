# Техническое задание: Экспорт диаграмм Mermaid в PNG

## 1. Общая информация

**Название задачи:** Реализация функционала экспорта диаграмм Mermaid в PNG изображения  
**Дата создания:** 2024  
**Версия:** 1.0  
**Приоритет:** Высокий  
**Статус:** ✅ Реализовано

## 2. Описание задачи

Необходимо добавить функционал экспорта всех диаграмм Mermaid из панели markdown в PNG изображения с возможностью выбора папки сохранения пользователем.

### 2.1. Контекст

В проекте WordMarkdownAddIn пользователи могут создавать и редактировать диаграммы Mermaid в панели markdown. Возникает необходимость сохранять эти диаграммы в виде изображений для использования в документах, презентациях и других целях.

### 2.2. Цель

Создать удобный механизм экспорта всех диаграмм Mermaid из текущего markdown документа в PNG файлы с сохранением качества, достаточного для чтения текста на диаграммах.

---

## 3. Требования к функционалу

### 3.1. Извлечение диаграмм Mermaid

**Требования:**
- Получать содержимое панели markdown через `TaskPaneControl.GetCachedMarkdown()` или `GetMarkdownAsync()`
- Находить все блоки кода с языком `mermaid` в формате:
  ```
  ```mermaid
  ...код диаграммы...
  ```
  ```
- Игнорировать остальной текст markdown
- Поддерживать обработку нескольких диаграмм в одном документе
- Сохранять порядок диаграмм согласно их расположению в документе

### 3.2. Конвертация в PNG

**Требования:**
- Конвертировать каждую найденную диаграмму Mermaid в PNG изображение
- Использовать существующий WebView2 из `TaskPaneControl` для рендеринга
- Сохранять изображения с расширением `.png`
- Обеспечивать качество изображения, достаточное для чтения текста на диаграмме
- Использовать библиотеку Mermaid через CDN (версия 10.9.0 или выше)

### 3.3. Пользовательский интерфейс

**Требования:**
- Добавить кнопку на ленте в отдельную группу "Экспорт"
- Название кнопки: "Экспорт Mermaid в PNG"
- При нажатии на кнопку открывать диалог выбора папки (`FolderBrowserDialog`)
- После выбора папки запускать процесс конвертации
- Отображать форму прогресс-бара во время обработки
- Показывать результаты операции пользователю

### 3.4. Обработка результатов

**Требования:**
- Для каждой диаграммы создавать отдельный PNG файл
- Именование файлов: `mermaid_1.png`, `mermaid_2.png`, `mermaid_3.png`, и т.д.
- Порядок номеров соответствует порядку диаграмм в markdown документе
- Показывать сообщение об успешном сохранении или об ошибках
- Отображать статистику: общее количество диаграмм, успешно обработанных, количество ошибок

### 3.5. Прогресс-бар

**Требования:**
- Отображать форму прогресс-бара при обработке множества диаграмм
- Показывать текущий прогресс в процентах
- Отображать информацию: "Обработка X из Y: имя_файла"
- Предоставлять возможность отмены операции через кнопку "Отмена"
- Закрывать форму автоматически по завершении операции

### 3.6. Обработка ошибок

**Требования:**
- Если диаграммы не найдены - показывать информационное сообщение пользователю
- Если диаграмма не рендерится - пропускать её, показывать ошибку в итоговом сообщении
- Если папка не выбрана - отменять операцию без сообщений
- Если WebView2 не готов - показывать сообщение об ошибке
- Собирать все ошибки и отображать их в итоговом сообщении
- Продолжать обработку остальных диаграмм при ошибке одной

---

## 4. Технические требования

### 4.1. Структура файлов

**Новые файлы:**
```
Services/
  └── MermaidExportService.cs    // Сервис для извлечения и конвертации диаграмм

ProgressForm.cs                   // Форма прогресс-бара
ProgressForm.Designer.cs          // Дизайнер формы прогресс-бара
```

**Изменяемые файлы:**
- `MarkdownRibbon.Designer.cs` - добавление группы "Экспорт" и кнопки
- `MarkdownRibbon.cs` - добавление обработчика кнопки
- `TaskPaneControl.cs` - добавление метода `GetWebView()`
- `WordMarkdownAddIn.csproj` - добавление новых файлов в проект

### 4.2. Зависимости

**Используемые библиотеки:**
- `Microsoft.Web.WebView2` - для рендеринга диаграмм (уже установлена)
- `System.IO` - для работы с файлами
- `System.Windows.Forms` - для диалогов и форм
- `System.Text.RegularExpressions` - для парсинга markdown
- `System.Threading` - для асинхронных операций

**Внешние ресурсы:**
- CDN библиотеки Mermaid: `https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js`

### 4.3. Использование WebView2

**Требования:**
- Использовать существующий WebView2 из `TaskPaneControl`
- Сохранять и восстанавливать состояние WebView2 после экспорта
- Обеспечивать корректную работу с панелью markdown после экспорта
- Переключать панель в HTML режим перед экспортом
- Восстанавливать исходное состояние панели после экспорта

---

## 5. Алгоритм работы

### 5.1. Последовательность действий

1. **Инициализация:**
   - Пользователь нажимает кнопку "Экспорт Mermaid в PNG" в группе "Экспорт"
   - Проверяется наличие панели markdown и её инициализация
   - Получается содержимое markdown из панели

2. **Проверка данных:**
   - Проверяется, что markdown не пуст
   - Проверяется готовность WebView2
   - Извлекаются все диаграммы Mermaid из markdown
   - Если диаграммы не найдены - показывается сообщение и операция завершается

3. **Выбор папки:**
   - Открывается диалог выбора папки (`FolderBrowserDialog`)
   - Если папка не выбрана - операция отменяется
   - Сохраняется путь к выбранной папке

4. **Подготовка к экспорту:**
   - Переключение панели в HTML режим
   - Ожидание инициализации WebView2
   - Открытие формы прогресс-бара

5. **Обработка диаграмм:**
   - Для каждой диаграммы последовательно:
     - Обновление прогресс-бара
     - Создание HTML-страницы с диаграммой
     - Загрузка HTML в WebView2
     - Ожидание рендеринга Mermaid
     - Получение скриншота через `CapturePreviewAsync`
     - Сохранение изображения в файл с именем `mermaid_N.png`
     - Обработка ошибок (пропуск при ошибке, запись в список ошибок)

6. **Завершение:**
   - Закрытие формы прогресс-бара
   - Восстановление исходного состояния панели markdown
   - Отображение итогового сообщения с результатами

### 5.2. Обработка одной диаграммы

**Алгоритм рендеринга:**
1. Создание HTML-шаблона с подключением библиотеки Mermaid
2. Вставка кода диаграммы в `<div class="mermaid">`
3. Загрузка HTML в WebView2 через `NavigateToString()`
4. Ожидание события `NavigationCompleted`
5. Инициализация Mermaid через JavaScript
6. Ожидание сигнала готовности от JavaScript (`mermaidReady`)
7. Получение скриншота через `CapturePreviewAsync()`
8. Сохранение изображения в файл

---

## 6. Классы и методы

### 6.1. MermaidExportService

**Основные методы:**
- `ExtractMermaidDiagrams(string markdown): List<string>` - извлечение диаграмм из markdown
- `RenderDiagramToPngAsync(string mermaidCode, WebView2 webView, string outputPath): Task<bool>` - рендеринг одной диаграммы
- `ExportAllDiagramsToPngAsync(...): Task<ExportResult>` - главный метод экспорта всех диаграмм
- `CreateMermaidHtml(string mermaidCode): string` - создание HTML-шаблона
- `WaitForMermaidRenderAsync(WebView2 webView): Task` - ожидание рендеринга
- `CaptureDiagramScreenshotAsync(WebView2 webView): Task<byte[]>` - получение скриншота

**Вспомогательные классы:**
- `ExportResult` - результат экспорта (количество, ошибки)
- `ExportProgress` - информация о прогрессе обработки

### 6.2. ProgressForm

**Методы:**
- `UpdateProgress(int current, int total, string fileName): void` - обновление прогресс-бара
- `btnCancel_Click(...): void` - обработка отмены операции

**Свойства:**
- `IsCancelled: bool` - флаг отмены операции

### 6.3. MarkdownRibbon

**Новый метод:**
- `btnExportMermaid_Click(...): void` - обработчик кнопки экспорта

### 6.4. TaskPaneControl

**Новый метод:**
- `GetWebView(): WebView2` - получение экземпляра WebView2

---

## 7. Обработка ошибок

### 7.1. Типы ошибок и их обработка

| Тип ошибки | Действие | Сообщение пользователю |
|------------|----------|------------------------|
| Панель не инициализирована | Прерывание | "Панель управления не инициализирована." |
| Markdown пуст | Прерывание | "Панель markdown пуста. Нет данных для экспорта." |
| WebView2 не готов | Прерывание | "WebView2 не готов. Подождите загрузки панели." |
| Диаграммы не найдены | Прерывание | "В markdown не найдено диаграмм Mermaid..." |
| Папка не выбрана | Прерывание | Нет (тихая отмена) |
| Ошибка рендеринга одной диаграммы | Пропуск, продолжение | В итоговом сообщении |
| Критическая ошибка | Прерывание | "Ошибка при экспорте: {сообщение}" |

### 7.2. Логирование

- Все ошибки логируются в `System.Diagnostics.Debug`
- Критические ошибки отображаются пользователю
- Ошибки отдельных диаграмм собираются и показываются в итоговом сообщении

---

## 8. Требования к качеству

### 8.1. Производительность

- Обработка одной диаграммы не должна занимать более 10 секунд
- При обработке множества диаграмм должна быть возможность отмены
- Прогресс-бар должен обновляться в реальном времени

### 8.2. Надежность

- Приложение не должно падать при ошибках рендеринга
- Состояние панели markdown должно восстанавливаться после экспорта
- WebView2 должен корректно работать после экспорта

### 8.3. Удобство использования

- Понятные сообщения об ошибках на русском языке
- Информативный прогресс-бар
- Возможность отмены длительной операции

---

## 9. Дополнительные требования

### 9.1. Именование файлов

- Формат: `mermaid_N.png`, где N - порядковый номер диаграммы (начиная с 1)
- Порядок соответствует порядку диаграмм в markdown документе
- Если файл с таким именем существует - он перезаписывается

### 9.2. Качество изображений

- Формат: PNG
- Разрешение: определяется автоматически WebView2
- Качество должно быть достаточным для чтения текста на диаграмме
- Фон: белый
- Размеры: автоматически определяются размерами диаграммы

### 9.3. Восстановление состояния

- После экспорта панель markdown должна вернуться в исходное состояние
- WebView2 должен отображать исходное содержимое панели
- Все элементы управления панели должны работать корректно

---

## 10. Ограничения

### 10.1. Технические ограничения

- Требуется наличие интернет-соединения для загрузки библиотеки Mermaid из CDN
- WebView2 должен быть инициализирован перед использованием
- Размер скриншота ограничен возможностями WebView2

### 10.2. Функциональные ограничения

- Экспортируются только диаграммы в формате ` ```mermaid ... ``` `
- Не поддерживаются встроенные диаграммы в других форматах
- Качество изображения зависит от настроек WebView2

---

## 11. Критерии приемки

### 11.1. Функциональные критерии

- [x] Кнопка "Экспорт Mermaid в PNG" отображается в группе "Экспорт"
- [x] При нажатии открывается диалог выбора папки
- [x] Находятся все диаграммы Mermaid в markdown
- [x] Каждая диаграмма конвертируется в PNG файл
- [x] Файлы сохраняются с именами `mermaid_1.png`, `mermaid_2.png`, и т.д.
- [x] Отображается прогресс-бар при обработке
- [x] Показывается итоговое сообщение с результатами
- [x] Ошибки обрабатываются корректно
- [x] Состояние панели восстанавливается после экспорта

### 11.2. Технические критерии

- [x] Код компилируется без ошибок
- [x] Все файлы включены в проект
- [x] Используется существующий WebView2
- [x] Нет утечек памяти
- [x] Корректная обработка асинхронных операций

---

## 12. Документация

### 12.1. Код

- Код должен быть читаемым и понятным
- Комментарии на русском языке для сложных участков
- Имена методов и переменных должны быть понятными

### 12.2. Инструкция

- Создана полная инструкция по реализации в файле `Инструкция_Экспорт_Mermaid_в_PNG.md`
- Инструкция содержит пошаговые действия и готовый код

---

## 13. История изменений

| Версия | Дата | Автор | Описание |
|--------|------|-------|----------|
| 1.0 | 2024 | - | Первоначальная версия технического задания |

---

**Статус:** ✅ Реализовано  
**Дата завершения:** 2024
