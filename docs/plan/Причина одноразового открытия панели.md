

## Причина проблемы

В `ThisAddIn.cs` панель создается один раз в методе `ThisAddIn_Startup`:

```35:40:ThisAddIn.cs
// 3. Создаем и настраиваем панель Markdown-редактора
PaneControl = new Controls.TaskPaneControl();
MarkdownPane = this.CustomTaskPanes.Add(PaneControl, "Markdown");
MarkdownPane.Visible = true;
MarkdownPane.DockPosition = Office.MsoCTPDockPosition.msoCTPDockPositionRight;
MarkdownPane.Width = 600;
```

В VSTO панель задач привязана к конкретному окну документа, а не к приложению. При открытии нового документа панель не создается автоматически, поэтому она видна только в том окне, где была создана.

## Решение

### 1. Хранение панелей для каждого окна

Вместо одной статической панели используйте словарь, где ключ — окно документа, значение — панель:

- Замените `public static CustomTaskPane MarkdownPane` на `Dictionary<Word.Window, CustomTaskPane>` или `Dictionary<Word.Document, CustomTaskPane>`.
- Также храните словарь контролов: `Dictionary<Word.Window, TaskPaneControl>`.

### 2. Подписка на события открытия документов

В `ThisAddIn_Startup` подпишитесь на:

- `Application.DocumentOpen` — открытие существующего документа
- `Application.NewDocument` — создание нового документа
- `Application.WindowActivate` — активация окна (для синхронизации содержимого)

### 3. Создание панели для нового документа/окна

В обработчиках событий:

- Проверьте, есть ли уже панель для этого окна/документа.
- Если нет, создайте новый `TaskPaneControl` и добавьте панель через `this.CustomTaskPanes.Add()`.
- Сохраните панель в словарь.
- Загрузите Markdown из документа в панель.

### 4. Синхронизация при переключении документов

В обработчике `Application.WindowActivate`:

- Сохраните Markdown из предыдущего активного документа.
- Загрузите Markdown из нового активного документа в соответствующую панель.
- Убедитесь, что панель для нового окна видна.

### 5. Очистка при закрытии документов

Подпишитесь на `Application.DocumentBeforeClose`:

- Сохраните Markdown перед закрытием.
- Удалите панель из словаря (если используете привязку к документу).

## Пошаговая реализация в Visual Studio 2022

1. Изменить структуру данных:
   - Заменить статические свойства на словари.
   - Добавить поле для отслеживания текущего активного документа/окна.

2. Создать метод `CreateTaskPaneForWindow(Word.Window window)`:
   - Создает новый `TaskPaneControl`.
   - Добавляет панель через `this.CustomTaskPanes.Add()`.
   - Настраивает параметры (ширина, позиция, видимость).
   - Сохраняет в словарь.

3. Создать метод `EnsureTaskPaneForActiveDocument()`:
   - Проверяет наличие панели для активного окна.
   - Если нет — вызывает `CreateTaskPaneForWindow()`.
   - Загружает Markdown из активного документа.

4. Подписаться на события в `ThisAddIn_Startup`:
   ```csharp
   this.Application.DocumentOpen += Application_DocumentOpen;
   this.Application.NewDocument += Application_NewDocument;
   this.Application.WindowActivate += Application_WindowActivate;
   this.Application.DocumentBeforeClose += Application_DocumentBeforeClose;
   ```

5. Реализовать обработчики событий:
   - `Application_DocumentOpen` — вызвать `EnsureTaskPaneForActiveDocument()`.
   - `Application_NewDocument` — вызвать `EnsureTaskPaneForActiveDocument()`.
   - `Application_WindowActivate` — синхронизировать содержимое панели.
   - `Application_DocumentBeforeClose` — сохранить Markdown и очистить ресурсы.

6. Обновить `TogglePane()`:
   - Работать с панелью активного окна из словаря.

7. Обновить `Application_DocumentBeforeSave`:
   - Сохранять Markdown из панели активного окна.

## Важные моменты

- В VSTO панель привязана к окну, а не к документу. Если один документ открыт в нескольких окнах, для каждого окна нужна своя панель.
- При переключении между окнами синхронизируйте содержимое панели с активным документом.
- Освобождайте ресурсы при закрытии окон/документов, чтобы избежать утечек памяти.

Это обеспечит наличие панели в каждом открытом документе и корректную синхронизацию содержимого.