# Инструкция по исправлению ошибки "Нет активного документа Word"

## Описание проблемы

**Симптомы:**
- Документ Word открыт и содержит данные
- При нажатии на кнопку "Word → Markdown (без форматирования)" появляется ошибка: "Ошибка при переносе текста: Нет активного документа Word."
- Данные не переносятся в панель Markdown

**Причина ошибки:**
Логическая ошибка в конструкторе класса `WordToMarkdownPlainTextService`. Условие проверки наличия активного документа **инвертировано** (перевернуто).

---

## Шаг 1: Локализация ошибки

### 1.1. Откройте файл с ошибкой

1. В **Solution Explorer** найдите папку `Services`
2. Откройте файл `WordToMarkdownPlainTextService.cs`
3. Перейдите к строке **31** (конструктор класса)

### 1.2. Найдите проблемный код

Проблемный код находится в конструкторе `WordToMarkdownPlainTextService()`:

```csharp
public WordToMarkdownPlainTextService()
{
    _wordApp = Globals.ThisAddIn.Application;
    _activeDoc = _wordApp.ActiveDocument;

    // Проверка, существует ли активный документ.
    if (_activeDoc != null)  // ❌ ОШИБКА: условие перевернуто!
    {
        // Если активного документа нет, выбрасывается исключение.
        throw new System.Exception("Нет активного документа Word.");
    }
}
```

**Проблема:** 
- Условие `if (_activeDoc != null)` означает "если документ ЕСТЬ"
- Но внутри блока выбрасывается исключение "Нет активного документа"
- Это логически неверно: код выбрасывает ошибку, когда документ **ЕСТЬ**, а должен выбрасывать, когда документа **НЕТ**

---

## Шаг 2: Исправление ошибки

### 2.1. Измените условие проверки

**Текущий код (неправильный):**
```csharp
if (_activeDoc != null)  // ❌ НЕПРАВИЛЬНО
{
    throw new System.Exception("Нет активного документа Word.");
}
```

**Исправленный код (правильный):**
```csharp
if (_activeDoc == null)  // ✅ ПРАВИЛЬНО
{
    throw new System.Exception("Нет активного документа Word.");
}
```

### 2.2. Полный исправленный фрагмент

Замените весь блок конструктора (строки 25-36) на следующий код:

```csharp
public WordToMarkdownPlainTextService()
{
    _wordApp = Globals.ThisAddIn.Application;  // Получение ссылки на приложение Word через Globals (объект, предоставляемый VSTO).
    _activeDoc = _wordApp.ActiveDocument;       // Получение ссылки на активный документ Word. 

    // Проверка, существует ли активный документ.
    if (_activeDoc == null)  // ✅ ИСПРАВЛЕНО: проверяем, что документа НЕТ
    {
        // Если активного документа нет, выбрасывается исключение.
        throw new System.Exception("Нет активного документа Word.");
    }
}
```

---

## Шаг 3: Проверка исправления

### 3.1. Визуальная проверка кода

Убедитесь, что:
- ✅ Условие изменено с `!= null` на `== null`
- ✅ Комментарий соответствует логике (проверяем отсутствие документа)
- ✅ Код компилируется без ошибок

### 3.2. Логическая проверка

Проверьте логику:
- **Если документ ЕСТЬ** (`_activeDoc != null`):
  - Условие `if (_activeDoc == null)` = `false`
  - Исключение НЕ выбрасывается ✅
  - Код продолжает работу ✅

- **Если документа НЕТ** (`_activeDoc == null`):
  - Условие `if (_activeDoc == null)` = `true`
  - Исключение выбрасывается ✅
  - Пользователь получает сообщение об ошибке ✅

---

## Шаг 4: Компиляция и тестирование

### 4.1. Компиляция проекта

1. Нажмите **Build** → **Build Solution** (или **Ctrl+Shift+B**)
2. Убедитесь, что проект компилируется **без ошибок**
3. Проверьте окно **Error List** (View → Error List) - не должно быть ошибок

### 4.2. Тестирование исправления

1. **Запустите надстройку в режиме отладки:**
   - Нажмите **F5** или **Debug** → **Start Debugging**
   - Дождитесь открытия Word с загруженной надстройкой

2. **Откройте тестовый документ:**
   - Откройте документ Word с текстом (например, тот же документ, который был на скриншоте)
   - Убедитесь, что документ активен (фокус на окне Word)

3. **Проверьте работу кнопки:**
   - Перейдите на вкладку **Markdown** в ленте Word
   - Найдите группу **Преобразование**
   - Нажмите кнопку **"Word → Markdown (без форматирования)"**

4. **Ожидаемый результат:**
   - ✅ **НЕ должно быть** сообщения об ошибке
   - ✅ Текст из документа должен появиться в панели Markdown справа
   - ✅ Должно появиться сообщение: "Текст из документа Word успешно перенесен в Markdown!"

### 4.3. Тестирование обработки ошибок

1. **Закройте все документы Word** (оставьте Word открытым)
2. **Нажмите кнопку** "Word → Markdown (без форматирования)"
3. **Ожидаемый результат:**
   - ✅ Должно появиться сообщение об ошибке: "Ошибка при переносе текста: Нет активного документа Word."
   - ✅ Приложение не должно падать

---

## Шаг 5: Сравнение с правильным кодом

### 5.1. Сравнение с существующим сервисом

Для справки, посмотрите на правильную реализацию в `WordToMarkdownService.cs` (строки 31-38):

```csharp
public WordToMarkdownService() 
{
    _wordApp = Globals.ThisAddIn.Application;
    _activeDoc = _wordApp.ActiveDocument;

    if (_activeDoc == null)  // ✅ ПРАВИЛЬНО: проверяем отсутствие
        throw new System.Exception("Нет активного документа Word.");
}
```

**Обратите внимание:** В правильном коде используется `== null`, а не `!= null`.

### 5.2. Общий паттерн проверки на null

В C# стандартный паттерн проверки на отсутствие объекта:

```csharp
// ✅ ПРАВИЛЬНО: проверяем отсутствие
if (объект == null)
{
    throw new Exception("Объект отсутствует");
}

// ❌ НЕПРАВИЛЬНО: проверяем наличие, но выбрасываем ошибку об отсутствии
if (объект != null)
{
    throw new Exception("Объект отсутствует");  // Логическая ошибка!
}
```

---

## Контрольный список исправления

- [ ] Открыт файл `Services/WordToMarkdownPlainTextService.cs`
- [ ] Найдена строка 31 с условием `if (_activeDoc != null)`
- [ ] Условие изменено на `if (_activeDoc == null)`
- [ ] Комментарий проверен на соответствие логике
- [ ] Проект скомпилирован без ошибок
- [ ] Протестирован сценарий: документ открыт → кнопка работает
- [ ] Протестирован сценарий: документ закрыт → показывается ошибка
- [ ] Все тесты проходят успешно

---

## Дополнительные замечания

### Почему произошла ошибка?

Это классическая **логическая ошибка** (inverted condition). Вероятные причины:
1. Опечатка при написании условия
2. Копирование кода с инвертированной логикой
3. Недостаточное тестирование на этапе разработки

### Как избежать подобных ошибок в будущем?

1. **Используйте осмысленные имена переменных:**
   ```csharp
   // Хорошо
   bool hasDocument = _activeDoc != null;
   if (!hasDocument) { ... }
   ```

2. **Пишите unit-тесты:**
   - Тест для случая, когда документ есть
   - Тест для случая, когда документа нет

3. **Используйте Code Review:**
   - Попросите коллегу проверить логику условий

4. **Сравнивайте с существующим кодом:**
   - Посмотрите, как реализована аналогичная проверка в `WordToMarkdownService`

---

## Резюме

**Ошибка:** В строке 31 файла `WordToMarkdownPlainTextService.cs` условие проверки инвертировано.

**Исправление:** Изменить `if (_activeDoc != null)` на `if (_activeDoc == null)`.

**Результат:** После исправления функционал будет работать корректно: выбрасывать исключение только когда документа действительно нет, и нормально работать когда документ открыт.

---

**Дата создания инструкции:** 29.12.2025  
**Версия:** 1.0  
**Статус:** Готово к использованию

