# Техническое задание: Окно прогресса при форматировании

## 1. Общая информация

**Название задачи:** Реализация окна прогресса для операций форматирования  
**Дата создания:** 2024  
**Версия:** 1.0  
**Приоритет:** Средний

## 2. Описание задачи

При выполнении операций форматирования текста между форматами Word и Markdown (в обе стороны) необходимо показывать пользователю окно с индикатором прогресса, если процесс занимает более 7 секунд.

### 2.1. Контекст

В проекте WordMarkdownAddIn выполняются следующие операции форматирования:

1. **Форматирование Markdown в Word** (`WordMarkdownFormatter`)
   - `FormatMarkdownInWord()` - форматирование указанного диапазона
   - `FormatSelectedText()` - форматирование выделенного текста
   - `FormatEntireDocument()` - форматирование всего документа

2. **Применение Markdown к Word** (`MarkdownToWordFormatter`)
   - `ApplyMarkdownToWord()` - применение Markdown-разметки к документу Word

3. **Преобразование Word в Markdown** (`WordToMarkdownService`)
   - `ConvertToMarkdown()` - преобразование документа Word в Markdown

### 2.2. Проблема

При обработке больших документов операции форматирования могут занимать значительное время. Пользователь не получает обратной связи о ходе выполнения операции, что создает впечатление "зависания" приложения.

## 3. Требования

### 3.1. Функциональные требования

1. **Автоматическое определение длительности операции**
   - Система должна отслеживать время выполнения операции форматирования
   - Если операция занимает более 7 секунд, должно отображаться окно прогресса
   - Если операция завершается быстрее 7 секунд, окно прогресса не показывается

2. **Отображение окна прогресса**
   - Окно должно появляться автоматически после 7 секунд выполнения операции
   - Окно должно содержать:
     - Заголовок с описанием выполняемой операции
     - Индикатор прогресса (ProgressBar)
     - Текстовое сообщение о текущем этапе обработки
     - Кнопку "Отмена" (опционально, для будущих версий)

3. **Обновление прогресса**
   - Индикатор прогресса должен обновляться в процессе выполнения операции
   - Текстовое сообщение должно отражать текущий этап обработки

4. **Закрытие окна**
   - Окно должно автоматически закрываться при завершении операции
   - Окно должно закрываться при возникновении ошибки

### 3.2. Нефункциональные требования

1. **Производительность**
   - Механизм отслеживания времени не должен существенно влиять на производительность
   - Окно прогресса должно обновляться плавно (не реже 1 раза в секунду)

2. **Пользовательский интерфейс**
   - Окно должно быть модальным, чтобы пользователь не мог взаимодействовать с Word во время операции
   - Дизайн окна должен соответствовать стилю Windows Forms
   - Окно должно быть центрировано на экране

3. **Надежность**
   - Окно должно корректно закрываться даже при возникновении исключений
   - Не должно возникать утечек ресурсов при закрытии окна

## 4. Технические детали реализации

### 4.1. Архитектура решения

Решение должно состоять из следующих компонентов:

1. **Класс `ProgressWindow`** - форма Windows Forms для отображения прогресса
2. **Класс `FormattingProgressManager`** - менеджер для управления окном прогресса
3. **Модификация существующих классов** - добавление поддержки прогресса в сервисы форматирования

### 4.2. Структура классов

#### 4.2.1. Класс `ProgressWindow`

**Расположение:** `Forms/ProgressWindow.cs` (новый файл)

**Назначение:** Windows Forms форма для отображения прогресса операции

**Свойства:**
- `string OperationName` - название операции (например, "Форматирование Markdown в Word")
- `string CurrentStage` - текущий этап обработки
- `int ProgressValue` - значение прогресса (0-100)

**Методы:**
- `void UpdateProgress(int value, string stage)` - обновление прогресса и текста этапа
- `void ShowProgress()` - показ окна
- `void HideProgress()` - скрытие окна

**Элементы интерфейса:**
- `Label lblOperation` - заголовок операции
- `ProgressBar progressBar` - индикатор прогресса
- `Label lblStage` - текст текущего этапа
- `Button btnCancel` - кнопка отмены (опционально, для будущих версий)

#### 4.2.2. Класс `FormattingProgressManager`

**Расположение:** `Services/FormattingProgressManager.cs` (новый файл)

**Назначение:** Управление отображением окна прогресса

**Свойства:**
- `TimeSpan Threshold` - порог времени для показа окна (7 секунд по умолчанию)
- `bool IsProgressVisible` - флаг, указывающий, видно ли окно прогресса

**Методы:**
- `void StartOperation(string operationName)` - начало операции
- `void UpdateProgress(int value, string stage)` - обновление прогресса
- `void CompleteOperation()` - завершение операции
- `void CancelOperation()` - отмена операции (для будущих версий)

**Логика работы:**
1. При вызове `StartOperation()` запускается таймер
2. Если операция длится более 7 секунд, показывается окно прогресса
3. В процессе выполнения вызывается `UpdateProgress()` для обновления индикатора
4. При завершении вызывается `CompleteOperation()` для закрытия окна

### 4.3. Интеграция с существующими сервисами

#### 4.3.1. Модификация `WordMarkdownFormatter`

**Файл:** `Services/WordMarkdownFormatter.cs`

**Изменения:**
1. Добавить поле `FormattingProgressManager _progressManager`
2. В методе `FormatMarkdownInWord()`:
   - Вызвать `_progressManager.StartOperation("Форматирование Markdown в Word")` в начале
   - Вызывать `_progressManager.UpdateProgress()` на ключевых этапах:
     - После валидации документа (10%)
     - После поиска элементов Markdown (30%)
     - После сортировки элементов (40%)
     - В цикле обработки элементов (40-90%)
     - После завершения (100%)
   - Вызвать `_progressManager.CompleteOperation()` в блоке `finally`

**Пример кода:**
```csharp
public void FormatMarkdownInWord(Range targetRange = null)
{
    _progressManager?.StartOperation("Форматирование Markdown в Word");
    try
    {
        // Валидация
        if (!ValidateDocument())
            return;
        _progressManager?.UpdateProgress(10, "Проверка документа...");

        // Поиск элементов
        var elements = FindAllMarkdownElements(rangeToProcess);
        _progressManager?.UpdateProgress(30, $"Найдено {elements.Count} элементов...");

        // Обработка элементов
        int processed = 0;
        foreach (var element in sortedElements)
        {
            ApplyFormattingToElement(element, rangeToProcess);
            processed++;
            int progress = 40 + (int)((double)processed / sortedElements.Count * 50);
            _progressManager?.UpdateProgress(progress, $"Обработано {processed} из {sortedElements.Count}...");
        }

        _progressManager?.UpdateProgress(100, "Завершено");
    }
    finally
    {
        _progressManager?.CompleteOperation();
    }
}
```

#### 4.3.2. Модификация `MarkdownToWordFormatter`

**Файл:** `Services/MarkdownToWordFormatter.cs`

**Изменения:**
1. Добавить поле `FormattingProgressManager _progressManager`
2. В методе `ApplyMarkdownToWord()`:
   - Вызвать `_progressManager.StartOperation("Применение Markdown к Word")` в начале
   - Вызывать `_progressManager.UpdateProgress()` на ключевых этапах
   - Вызвать `_progressManager.CompleteOperation()` в блоке `finally`

#### 4.3.3. Модификация `WordToMarkdownService`

**Файл:** `Services/WordToMarkdownService.cs`

**Изменения:**
1. Добавить поле `FormattingProgressManager _progressManager`
2. В методе `ConvertToMarkdown()`:
   - Вызвать `_progressManager.StartOperation("Преобразование Word в Markdown")` в начале
   - Вызывать `_progressManager.UpdateProgress()` на ключевых этапах
   - Вызвать `_progressManager.CompleteOperation()` в блоке `finally`

### 4.4. Обработка ошибок

1. При возникновении исключения окно прогресса должно быть закрыто
2. Ошибка должна логироваться, но не должна прерывать закрытие окна
3. Использовать блок `try-finally` для гарантированного закрытия окна

## 5. Интерфейс окна прогресса

### 5.1. Визуальный дизайн

```
┌─────────────────────────────────────────┐
│  Форматирование Markdown в Word         │
├─────────────────────────────────────────┤
│                                         │
│  [████████████████░░░░░░░░░░░░░░] 60%  │
│                                         │
│  Обработано 150 из 250 элементов...    │
│                                         │
│                    [Отмена]             │
└─────────────────────────────────────────┘
```

### 5.2. Элементы интерфейса

1. **Заголовок окна:** Название операции (например, "Форматирование Markdown в Word")
2. **ProgressBar:** Горизонтальный индикатор прогресса (0-100%)
3. **Label (lblStage):** Текстовое описание текущего этапа
4. **Button (btnCancel):** Кнопка отмены (опционально, для будущих версий)

### 5.3. Размеры и расположение

- **Размер окна:** 400x150 пикселей
- **Расположение:** Центр экрана
- **Стиль:** Модальное окно (FormBorderStyle.FixedDialog)
- **Поведение:** Нельзя изменять размер, нельзя минимизировать

## 6. Алгоритм работы

### 6.1. Последовательность действий

1. **Начало операции:**
   - Пользователь запускает операцию форматирования
   - Вызывается `FormattingProgressManager.StartOperation()`
   - Запускается таймер для отслеживания времени

2. **Отслеживание времени:**
   - Если операция завершается до истечения 7 секунд:
     - Окно прогресса не показывается
     - Операция завершается нормально
   - Если операция длится более 7 секунд:
     - Показывается окно прогресса
     - Начинается обновление индикатора прогресса

3. **Обновление прогресса:**
   - В процессе выполнения операции вызывается `UpdateProgress()`
   - Обновляется значение ProgressBar
   - Обновляется текст текущего этапа

4. **Завершение операции:**
   - Вызывается `CompleteOperation()`
   - Окно прогресса закрывается
   - Операция завершается

### 6.2. Обработка исключений

```
try
{
    _progressManager?.StartOperation("Операция");
    // Выполнение операции
    _progressManager?.UpdateProgress(100, "Завершено");
}
catch (Exception ex)
{
    // Логирование ошибки
    LogError(ex);
}
finally
{
    // Гарантированное закрытие окна
    _progressManager?.CompleteOperation();
}
```

## 7. Тестирование

### 7.1. Сценарии тестирования

1. **Быстрая операция (< 7 секунд)**
   - Запустить форматирование небольшого документа
   - Убедиться, что окно прогресса не появляется
   - Убедиться, что операция завершается корректно

2. **Долгая операция (> 7 секунд)**
   - Запустить форматирование большого документа
   - Убедиться, что окно прогресса появляется через 7 секунд
   - Убедиться, что индикатор прогресса обновляется
   - Убедиться, что окно закрывается после завершения

3. **Ошибка во время операции**
   - Симулировать ошибку во время форматирования
   - Убедиться, что окно прогресса закрывается
   - Убедиться, что ошибка обрабатывается корректно

4. **Множественные операции**
   - Запустить несколько операций подряд
   - Убедиться, что окно прогресса корректно открывается и закрывается для каждой операции

### 7.2. Критерии приемки

- [ ] Окно прогресса появляется только если операция длится более 7 секунд
- [ ] Индикатор прогресса обновляется в процессе выполнения
- [ ] Окно прогресса автоматически закрывается при завершении операции
- [ ] Окно прогресса закрывается при возникновении ошибки
- [ ] Не возникает утечек ресурсов при закрытии окна
- [ ] Производительность не ухудшается при использовании механизма прогресса

## 8. План реализации

### Этап 1: Создание базовых компонентов
1. Создать класс `ProgressWindow` (Windows Forms форма)
2. Создать класс `FormattingProgressManager`
3. Реализовать базовую логику отслеживания времени

### Этап 2: Интеграция с WordMarkdownFormatter
1. Добавить поддержку прогресса в `WordMarkdownFormatter`
2. Добавить вызовы `UpdateProgress()` на ключевых этапах
3. Протестировать на различных размерах документов

### Этап 3: Интеграция с MarkdownToWordFormatter
1. Добавить поддержку прогресса в `MarkdownToWordFormatter`
2. Добавить вызовы `UpdateProgress()` на ключевых этапах
3. Протестировать

### Этап 4: Интеграция с WordToMarkdownService
1. Добавить поддержку прогресса в `WordToMarkdownService`
2. Добавить вызовы `UpdateProgress()` на ключевых этапах
3. Протестировать

### Этап 5: Финальное тестирование
1. Тестирование всех сценариев
2. Проверка производительности
3. Исправление найденных ошибок

## 9. Дополнительные замечания

### 9.1. Будущие улучшения

1. **Кнопка отмены:** В будущих версиях можно добавить возможность отмены операции
2. **Настройка порога:** Можно добавить настройку порога времени (7 секунд) в настройках приложения
3. **Детальная информация:** Можно добавить более детальную информацию о прогрессе (скорость обработки, оставшееся время)

### 9.2. Альтернативные решения

1. **BackgroundWorker:** Можно использовать `BackgroundWorker` для асинхронного выполнения операций
2. **Task/async-await:** Можно использовать асинхронные методы для неблокирующего выполнения
3. **Progress<T>:** Можно использовать `IProgress<T>` для более гибкого управления прогрессом

### 9.3. Ограничения

1. Окно прогресса не должно блокировать поток выполнения операции (Word Interop требует выполнения в основном потоке)
2. Обновление UI должно выполняться через `Invoke()` если необходимо
3. Не должно быть конфликтов с существующим кодом

## 10. Заключение

Данное техническое задание описывает реализацию окна прогресса для операций форматирования в проекте WordMarkdownAddIn. Реализация должна быть выполнена с учетом требований производительности, надежности и удобства использования.

---

**Дата создания:** 2024  
**Версия:** 1.0  
**Статус:** К реализации




