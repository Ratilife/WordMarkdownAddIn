# Проблема: Первый элемент списка отображается как пустая строка с маркером

## Описание проблемы

После применения заголовка уровня 3 "✅ Сохранение Markdown в документ" первый элемент списка отображается как **пустая строка с маркером списка**, хотя должен содержать текст "Метод SaveMarkdownToActiveDocument() - сохраняет Markdown в активный документ".

## Анализ последовательности выполнения

### 1. Применение заголовка (WordTitle.ApplyToWord)

**Файл:** `Services/IWordElement.cs`, строки 871-1008

```csharp
// 1. Создаем параграф
var paragraph = doc.Content.Paragraphs.Add();

// 2. Вставляем текст заголовка
Content.ApplyToWord(doc, paragraph.Range);

// 3. Применяем стиль заголовка
textRange.set_Style(headingStyle);

// 6. Добавляем перенос строки
paragraph.Range.InsertParagraphAfter();  // ← СТРОКА 997

// Очищаем форматирование списка у параграфа, созданного через InsertParagraphAfter
var lastParagraphIndex = doc.Content.Paragraphs.Count;
if (lastParagraphIndex > 0)
{
    var newParagraph = doc.Content.Paragraphs[lastParagraphIndex];
    newParagraph.Range.ListFormat.RemoveNumbers();  // ← СТРОКА 1005
}
```

**Что происходит:**
- После заголовка создается **пустой параграф** через `InsertParagraphAfter()`
- Этот пустой параграф очищается от форматирования списка через `RemoveNumbers()`

### 2. Применение первого элемента списка (WordListItem.ApplyToWord)

**Файл:** `Services/IWordElement.cs`, строки 461-535

```csharp
// 1. Создаем параграф для элемента списка
var listParagraph = doc.Content.Paragraphs.Add();  // ← СТРОКА 490

// 2. Применяем форматированный текст
content.ApplyToWord(doc, listParagraph.Range);  // ← СТРОКА 495

// 3. Применяем форматирование списка
listParagraph.Range.ListFormat.ApplyBulletDefault();  // ← СТРОКА 513
```

**Что происходит:**
- Создается новый параграф через `Paragraphs.Add()`
- Вызывается `content.ApplyToWord(doc, listParagraph.Range)`

### 3. Вставка текста (WordFormattedText.ApplyToWord)

**Файл:** `Services/IWordElement.cs`, строки 85-206

```csharp
public void ApplyToWord(Document doc, Range range)
{
    foreach (var run in Runs)
    {
        // 1) Запоминаем позицию начала вставки
        int start = range.End;  // ← СТРОКА 97

        // 2) Вставляем текст в конец текущего range
        range.InsertAfter(run.Text);  // ← СТРОКА 177
        end = start + run.Text.Length;
        
        // 5) Сдвигаем исходный range в конец
        range.SetRange(end, end);  // ← СТРОКА 204
    }
}
```

## Найденная проблема

### Проблема #1: Параграф не очищается перед вставкой текста

В `WordListItem.ApplyToWord()` на строке 490 создается новый параграф:

```csharp
var listParagraph = doc.Content.Paragraphs.Add();
```

**НО:** Параграф **не очищается** перед вставкой текста! 

Когда создается новый параграф через `Paragraphs.Add()`, он может содержать:
- Символ конца параграфа `\r` или `\a`
- Текст по умолчанию (если Word добавляет его)
- Форматирование от предыдущего элемента

### Проблема #2: Range может включать предыдущий контент

В `WordFormattedText.ApplyToWord()` на строке 97:

```csharp
int start = range.End;
```

Если `listParagraph.Range` включает предыдущий пустой параграф (созданный после заголовка), то:
- `range.End` может указывать на позицию в предыдущем параграфе
- Текст вставляется в неправильное место
- Форматирование списка применяется к неправильному параграфу

### Проблема #3: Пустой параграф после заголовка может наследовать форматирование списка

После заголовка создается пустой параграф через `InsertParagraphAfter()`. Этот параграф очищается от форматирования списка, **НО:**

Когда применяется первый элемент списка:
1. Создается новый параграф через `Paragraphs.Add()`
2. Применяется форматирование списка через `ApplyBulletDefault()`

**Проблема:** Если пустой параграф после заголовка все еще существует и находится рядом с новым параграфом списка, Word может автоматически применить форматирование списка к пустому параграфу, создавая пустой элемент списка.

## Точная причина проблемы

**Главная проблема:** В `WordListItem.ApplyToWord()` параграф **не очищается** перед вставкой текста, аналогично тому, как это делается в `WordTitle.ApplyToWord()` (строка 898) и `WordParagraph.ApplyToWord()` (строка 657).

Когда создается новый параграф через `Paragraphs.Add()`, он может содержать:
- Символ конца параграфа
- Текст или форматирование от предыдущего элемента
- Связь с предыдущим пустым параграфом

Если параграф не очищается, то:
1. `listParagraph.Range` может включать предыдущий контент
2. `content.ApplyToWord()` вставляет текст в неправильное место
3. Форматирование списка применяется к неправильному параграфу (возможно, к пустому параграфу после заголовка)

## Решение (не применять, только для справки)

Проблема решается добавлением очистки параграфа перед вставкой текста в `WordListItem.ApplyToWord()`:

```csharp
// 1. Создаем параграф для элемента списка
var listParagraph = doc.Content.Paragraphs.Add();

// КРИТИЧЕСКИ ВАЖНО: Очищаем параграф перед вставкой текста
listParagraph.Range.Text = "";  // ← ДОБАВИТЬ ЭТУ СТРОКУ

// 2. Применяем форматированный текст
content.ApplyToWord(doc, listParagraph.Range);
```

Это гарантирует, что:
1. Параграф пустой перед вставкой текста
2. `listParagraph.Range` не включает предыдущий контент
3. Текст вставляется в правильное место
4. Форматирование списка применяется к правильному параграфу

## Дополнительная проблема: Последний элемент не попадает в список

Последний элемент списка "Оборачивает содержимое в CDATA..." отображается как обычный параграф, а не как элемент списка.

**Возможная причина:** После последнего элемента списка вызывается `InsertParagraphAfter()` (строка 518), который создает пустой параграф. Затем этот пустой параграф очищается от форматирования списка (строка 529). 

Но если после этого применяется следующий элемент (или документ заканчивается), Word может неправильно определить границы списка, и последний элемент может потерять форматирование списка.

**Решение:** Не создавать пустой параграф после последнего элемента списка, или не очищать форматирование списка у последнего элемента.

