# Инструкция по проверке проблемы #6: Проблемы с позициями токенов

## Проблема
Токены парсятся относительно `originalCode`, но позиции применяются к `range`, где текст может отличаться. Это приводит к тому, что токены пропускаются из-за неверных границ.

## Как проверить

### Шаг 1: Временно заменить вызов HighlightCodeBlock на диагностику

Откройте файл `Services/IWordElement.cs` и найдите строку 748:

```csharp
SyntaxHighlighter.HighlightCodeBlock(codeRange, Code, normalizedLanguage);
```

**Временно замените** на:

```csharp
// ВРЕМЕННО: Диагностика проблемы с позициями токенов
SyntaxHighlighterDiagnostics.DiagnoseTokenPositions(codeRange, Code, normalizedLanguage);
// Оригинальный вызов (закомментирован для диагностики):
// SyntaxHighlighter.HighlightCodeBlock(codeRange, Code, normalizedLanguage);
```

### Шаг 2: Скомпилировать и запустить проект

1. Соберите проект (Build → Build Solution)
2. Запустите Word с вашим Add-In
3. Создайте или откройте документ с код-блоком в Markdown, например:
   ```markdown
   ```python
   def hello():
       print("Hello, World!")
   ```
   ```
4. Нажмите кнопку "Markdown → Word" в ленте

### Шаг 3: Просмотреть вывод диагностики

Откройте **Output** окно в Visual Studio:
- View → Output (или Ctrl+Alt+O)
- В выпадающем списке выберите "Debug"

Вы увидите детальный вывод, который покажет:

1. **Сравнение текстов:**
   - Длины `originalCode` и `rangeText`
   - Совпадают ли тексты
   - Первое различие (если есть)

2. **Анализ токенов:**
   - Сколько токенов найдено
   - Для каждого токена:
     - Позиция в `originalCode`
     - Выходит ли за границы `normalizedRange`
     - Абсолютные позиции в документе
     - Совпадает ли текст токена в Range с ожидаемым

3. **Итоги:**
   - Сколько токенов применено
   - Сколько пропущено
   - Причины пропуска

### Шаг 4: Интерпретация результатов

#### Если тексты НЕ совпадают:
```
⚠️ КРИТИЧЕСКАЯ ПРОБЛЕМА: Тексты не совпадают!
```
**Это основная причина проблемы.** Токены парсятся относительно одного текста, но применяются к другому.

**Что искать:**
- Различия в длине текстов
- Различия в символах (пробелы, переносы строк, специальные символы)
- Позицию первого различия

#### Если токены пропускаются:
```
⚠️ ПРОБЛЕМА: X токенов пропущено из-за неверных позиций
```
**Причины пропуска:**
- `❌ ТОКЕН БУДЕТ ПРОПУЩЕН: выходит за границы` - позиция токена выходит за пределы `normalizedRange.Length`
- `❌ ТОКЕН БУДЕТ ПРОПУЩЕН: выходит за границы Range` - абсолютная позиция выходит за пределы Range документа
- `⚠️ ВНИМАНИЕ: Текст токена не совпадает!` - текст в Range не соответствует ожидаемому

### Шаг 5: Примеры проблемных сценариев

#### Сценарий 1: Различие в переносах строк
```
OriginalCode: "def hello():\n    print('Hi')"
RangeText: "def hello():\r\n    print('Hi')"
```
Word может преобразовать `\n` в `\r\n`, что изменит позиции.

#### Сценарий 2: Лишние символы в Range
```
OriginalCode: "def hello():"
RangeText: "def hello():\r"  // Word добавил \r в конце
```
После `TrimEnd` тексты совпадают, но позиции могут быть смещены.

#### Сценарий 3: Различие в пробелах
```
OriginalCode: "def hello():"
RangeText: "def  hello():"  // Двойной пробел вместо одного
```
Позиции всех токенов после этого места будут неверными.

### Шаг 6: После диагностики

1. **Верните оригинальный код:**
   ```csharp
   SyntaxHighlighter.HighlightCodeBlock(codeRange, Code, normalizedLanguage);
   ```

2. **Удалите диагностический файл** (если не нужен):
   - `Services/SyntaxHighlighter_Diagnostics.cs`

3. **Исправьте проблему** на основе результатов диагностики

## Что делать с результатами

### Если тексты не совпадают:
- Проверьте, как создается `codeRange` в `ApplyToWord`
- Убедитесь, что `codeRange.Text` точно соответствует `Code`
- Возможно, нужно использовать реальный текст из Range для парсинга токенов

### Если токены пропускаются:
- Проверьте логику вычисления позиций
- Убедитесь, что `maxLength` используется правильно
- Возможно, нужно пересчитать позиции токенов относительно `normalizedRange` вместо `originalCode`

## Дополнительные проверки

### Проверка 1: Визуальная проверка текста в Word
После применения Markdown → Word:
1. Выделите блок кода в Word
2. Скопируйте текст (Ctrl+C)
3. Сравните с исходным кодом из Markdown

### Проверка 2: Проверка через Immediate Window
В Visual Studio во время отладки:
```csharp
?codeRange.Text
?Code
?codeRange.Text.Length
?Code.Length
```

### Проверка 3: Проверка позиций вручную
Добавьте breakpoint в `ApplyHighlightingToWordRange` и проверьте:
- `normalizedCode` vs `normalizedRange`
- Позиции первых нескольких токенов
- Соответствие текста токена в Range

