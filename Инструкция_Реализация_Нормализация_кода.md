# Пошаговая инструкция: Реализация нормализации кода перед вставкой

## Обзор

Эта инструкция описывает пошаговую реализацию нормализации кода перед вставкой в Word согласно техническому заданию `ТЗ_Нормализация_кода_перед_вставкой.md`.

**Цель:** Удалять все пустые строки из кода перед вставкой в Word, чтобы предотвратить появление лишних пустых строк в Markdown-представлении.

## Шаг 1: Открыть файл для редактирования

### 1.1. Найти файл
Откройте файл: `Services/IWordElement.cs`

### 1.2. Найти класс WordCodeBlock
Найдите класс `WordCodeBlock` (примерно строка 1044).

### 1.3. Найти метод ApplyToWord
Найдите метод `ApplyToWord(Document doc)` внутри класса `WordCodeBlock` (примерно строка 1208).

## Шаг 2: Добавить метод нормализации кода

### 2.1. Определить место для нового метода

Добавьте новый приватный метод `NormalizeCode` **перед** методом `ApplyToWord`.

**Местоположение:** После метода `ToMarkdown()` (примерно после строки 1122) и перед методом `ApplyToWord()` (примерно перед строкой 1208).

### 2.2. Добавить метод NormalizeCode

Вставьте следующий код:

```csharp
/// <summary>
/// Нормализует код, удаляя все пустые строки.
/// Пустой строкой считается строка, содержащая только пробелы, табуляции, переносы строк или их комбинации.
/// </summary>
/// <param name="code">Исходный код для нормализации</param>
/// <returns>Нормализованный код без пустых строк</returns>
private string NormalizeCode(string code)
{
    // Проверяем, что код не пустой
    if (string.IsNullOrEmpty(code))
        return code;

    // Разбиваем код на строки, учитывая различные форматы переносов строк
    // StringSplitOptions.None сохраняет пустые строки в массиве для последующей фильтрации
    var lines = code.Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.None);

    // Удаляем все пустые строки (строки, содержащие только пробелы, табуляции и т.д.)
    var nonEmptyLines = lines.Where(line => !string.IsNullOrWhiteSpace(line));

    // Объединяем непустые строки обратно в одну строку с использованием Unix-формата переносов (\n)
    return string.Join("\n", nonEmptyLines);
}
```

### 2.3. Проверить наличие необходимых using-директив

Убедитесь, что в начале файла есть:
```csharp
using System.Linq;
```

Если директивы нет, добавьте её в начало файла вместе с другими using-директивами.

## Шаг 3: Изменить метод ApplyToWord

### 3.1. Найти место вставки нормализации

В методе `ApplyToWord` найдите строку:
```csharp
// 1.Сохраняем начальную позицию
int startPos = doc.Content.End - 1;

// 2.Вставляем код через InsertAfter
var insertRange = doc.Range(startPos);
insertRange.InsertAfter(Code);  // ← ЭТУ СТРОКУ НУЖНО ИЗМЕНИТЬ
```

### 3.2. Добавить нормализацию кода

**Замените** блок кода:
```csharp
// 1.Сохраняем начальную позицию
int startPos = doc.Content.End - 1;

// 2.Вставляем код через InsertAfter
var insertRange = doc.Range(startPos);
insertRange.InsertAfter(Code);
```

**На** следующий блок:
```csharp
// 1. НОРМАЛИЗАЦИЯ КОДА: Удаляем все пустые строки перед вставкой
string normalizedCode = NormalizeCode(Code);

// Проверяем, что после нормализации код не стал пустым
if (string.IsNullOrEmpty(normalizedCode))
{
    // Если код стал пустым после нормализации, ничего не вставляем
    return;
}

// 2. Сохраняем начальную позицию
int startPos = doc.Content.End - 1;

// 3. Вставляем нормализованный код через InsertAfter
var insertRange = doc.Range(startPos);
insertRange.InsertAfter(normalizedCode);  // ← Используем normalizedCode вместо Code
```

### 3.3. Проверить остальной код

Убедитесь, что остальной код метода `ApplyToWord` остался без изменений. Должны остаться:
- Создание Range для вставленного кода
- Применение форматирования (шрифт, фон, отступы)
- Применение подсветки синтаксиса
- Добавление пустого параграфа после кода

## Шаг 4: Проверить компиляцию

### 4.1. Собрать проект

1. Откройте меню **Build** → **Build Solution** (или нажмите `Ctrl+Shift+B`)
2. Убедитесь, что проект компилируется без ошибок
3. Если есть ошибки компиляции, проверьте:
   - Правильность синтаксиса
   - Наличие директивы `using System.Linq;`
   - Правильность имен методов и переменных

### 4.2. Исправить ошибки (если есть)

**Ошибка:** "The name 'Where' does not exist in the current context"
**Решение:** Добавьте `using System.Linq;` в начало файла

**Ошибка:** "The name 'NormalizeCode' does not exist in the current context"
**Решение:** Убедитесь, что метод `NormalizeCode` находится внутри класса `WordCodeBlock`

## Шаг 5: Тестирование

### 5.1. Тест 1: Код без пустых строк

**Действия:**
1. Создайте блок кода в Markdown без пустых строк:
   ```
   Документ Word
   ├── Content
   │   ├── Paragraph 1
   ```

2. Преобразуйте Markdown → Word
3. Преобразуйте Word → Markdown

**Ожидаемый результат:** Код должен остаться без изменений, пустых строк не должно появиться.

### 5.2. Тест 2: Код с пустыми строками

**Действия:**
1. Создайте блок кода в Markdown с пустыми строками:
   ```
   Документ Word
   
   ├── Content
   
   │   ├── Paragraph 1
   ```

2. Преобразуйте Markdown → Word
3. Преобразуйте Word → Markdown

**Ожидаемый результат:** Пустые строки должны быть удалены:
   ```
   Документ Word
   ├── Content
   │   ├── Paragraph 1
   ```

### 5.3. Тест 3: Код с множественными пустыми строками

**Действия:**
1. Создайте блок кода с несколькими пустыми строками подряд:
   ```
   Документ Word
   
   
   ├── Content
   
   
   │   ├── Paragraph 1
   ```

2. Преобразуйте Markdown → Word
3. Преобразуйте Word → Markdown

**Ожидаемый результат:** Все пустые строки должны быть удалены.

### 5.4. Тест 4: Пустой код

**Действия:**
1. Попробуйте вставить пустой блок кода
2. Проверьте, что не возникает ошибок

**Ожидаемый результат:** Пустой код не должен вставляться, ошибок не должно быть.

### 5.5. Тест 5: Код с отступами

**Действия:**
1. Создайте блок кода с отступами:
   ```
   Документ Word
   
       ├── Content
   
           │   ├── Paragraph 1
   ```

2. Преобразуйте Markdown → Word
3. Преобразуйте Word → Markdown

**Ожидаемый результат:** Отступы должны сохраниться, пустые строки удалены:
   ```
   Документ Word
       ├── Content
           │   ├── Paragraph 1
   ```

## Шаг 6: Проверка обратной совместимости

### 6.1. Проверить существующие блоки кода

1. Откройте документ Word с существующими блоками кода
2. Преобразуйте Word → Markdown
3. Убедитесь, что существующие блоки кода работают корректно

### 6.2. Проверить форматирование

1. Создайте блок кода с форматированием (жирный текст, курсив и т.д.)
2. Преобразуйте Markdown → Word
3. Убедитесь, что форматирование сохраняется

### 6.3. Проверить подсветку синтаксиса

1. Создайте блок кода с указанием языка (например, `csharp`, `python`)
2. Преобразуйте Markdown → Word
3. Убедитесь, что подсветка синтаксиса работает корректно

## Шаг 7: Финальная проверка

### 7.1. Проверить критерии приемки

Убедитесь, что выполнены все критерии из ТЗ:

- ✅ Все пустые строки удаляются из кода перед вставкой
- ✅ Структура и порядок непустых строк сохраняются
- ✅ Отступы в начале строк сохраняются
- ✅ Различные форматы переносов строк обрабатываются корректно
- ✅ Код соответствует стандартам проекта
- ✅ Добавлены XML-комментарии к новому методу
- ✅ Обработаны граничные случаи (null, пустые строки и т.д.)
- ✅ В Markdown-представлении блоков кода нет лишних пустых строк

### 7.2. Проверить код на соответствие стандартам

1. Убедитесь, что код отформатирован правильно
2. Проверьте, что все комментарии на русском языке (если это стандарт проекта)
3. Убедитесь, что имена методов и переменных соответствуют соглашениям

## Шаг 8: Документирование (опционально)

### 8.1. Обновить документацию

Если в проекте есть документация, обновите её, указав:
- Что код нормализуется перед вставкой в Word
- Что пустые строки удаляются автоматически

### 8.2. Добавить комментарии (если нужно)

Если какие-то части кода требуют дополнительных пояснений, добавьте комментарии.

## Итоговый код

### Полный метод NormalizeCode

```csharp
/// <summary>
/// Нормализует код, удаляя все пустые строки.
/// Пустой строкой считается строка, содержащая только пробелы, табуляции, переносы строк или их комбинации.
/// </summary>
/// <param name="code">Исходный код для нормализации</param>
/// <returns>Нормализованный код без пустых строк</returns>
private string NormalizeCode(string code)
{
    // Проверяем, что код не пустой
    if (string.IsNullOrEmpty(code))
        return code;

    // Разбиваем код на строки, учитывая различные форматы переносов строк
    // StringSplitOptions.None сохраняет пустые строки в массиве для последующей фильтрации
    var lines = code.Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.None);

    // Удаляем все пустые строки (строки, содержащие только пробелы, табуляции и т.д.)
    var nonEmptyLines = lines.Where(line => !string.IsNullOrWhiteSpace(line));

    // Объединяем непустые строки обратно в одну строку с использованием Unix-формата переносов (\n)
    return string.Join("\n", nonEmptyLines);
}
```

### Измененный фрагмент метода ApplyToWord

```csharp
// 1. НОРМАЛИЗАЦИЯ КОДА: Удаляем все пустые строки перед вставкой
string normalizedCode = NormalizeCode(Code);

// Проверяем, что после нормализации код не стал пустым
if (string.IsNullOrEmpty(normalizedCode))
{
    // Если код стал пустым после нормализации, ничего не вставляем
    return;
}

// 2. Сохраняем начальную позицию
int startPos = doc.Content.End - 1;

// 3. Вставляем нормализованный код через InsertAfter
var insertRange = doc.Range(startPos);
insertRange.InsertAfter(normalizedCode);  // ← Используем normalizedCode вместо Code
```

## Возможные проблемы и решения

### Проблема 1: Ошибка компиляции "The name 'Where' does not exist"

**Причина:** Отсутствует директива `using System.Linq;`

**Решение:** Добавьте в начало файла:
```csharp
using System.Linq;
```

### Проблема 2: Метод NormalizeCode не найден

**Причина:** Метод находится вне класса `WordCodeBlock`

**Решение:** Убедитесь, что метод `NormalizeCode` находится внутри класса `WordCodeBlock`, перед методом `ApplyToWord`.

### Проблема 3: Пустые строки всё ещё появляются

**Причина:** Возможно, проблема в другом месте (извлечение кода из Word)

**Решение:** Проверьте, что изменения применены правильно, и перезапустите приложение.

### Проблема 4: Отступы теряются

**Причина:** Метод `NormalizeCode` не должен влиять на отступы

**Решение:** Убедитесь, что используется `string.IsNullOrWhiteSpace(line)`, а не `string.IsNullOrEmpty(line)`. Первый метод сохраняет строки с пробелами/табуляциями.

## Чеклист выполнения

- [ ] Шаг 1: Открыт файл `Services/IWordElement.cs`
- [ ] Шаг 2: Добавлен метод `NormalizeCode` с XML-комментариями
- [ ] Шаг 3: Изменен метод `ApplyToWord` для использования нормализованного кода
- [ ] Шаг 4: Проект компилируется без ошибок
- [ ] Шаг 5: Выполнены все тесты (ТС-1 - ТС-5)
- [ ] Шаг 6: Проверена обратная совместимость
- [ ] Шаг 7: Выполнены все критерии приемки
- [ ] Шаг 8: Документация обновлена (если требуется)

## Заключение

После выполнения всех шагов нормализация кода перед вставкой в Word будет реализована. Это предотвратит появление пустых строк в Markdown-представлении блоков кода.

**Время выполнения:** 2-4 часа  
**Сложность:** Низкая  
**Риски:** Минимальные

